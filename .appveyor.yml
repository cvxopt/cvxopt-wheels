version: 1.2.4.{build}-{branch}
image: Visual Studio 2017
init:
    - choco install wget checksum

environment:
  global:
    PYTHON: C:\Miniconda37-x64
    PYTHON_ARCH: "64"
    REPO_DIR: "cvxopt"
    PACKAGE_NAME: "cvxopt"
    BUILD_COMMIT: "HEAD"
    BUILD_DEPENDS: "mkl==2018.0.3"
    TEST_DEPENDS: "pytest"
    CVXOPT_BUILD_DSDP: "0"
    CVXOPT_BUILD_GLPK: "1"
    CVXOPT_INSTALL_REQUIRES: mkl
    CVXOPT_BLAS_LIB: "mkl_rt"
    CVXOPT_LAPACK_LIB: "mkl_rt"
    GLPK_VERSION: "4.65"
    GLPK_SHA256: "4281e29b628864dfe48d393a7bedd781e5b475387c20d8b0158f329994721a10"
    SUITESPARSE_VERSION: "5.6.0"
    SUITESPARSE_SHA256: "dc2c56c21c5f18811e28dc673dd79039e1cc81cda6e694842661498d346d669e"

  matrix:
    - PYTHON_VERSION: "3.7"
      CVXOPT_MSVC: "1"
    - PYTHON_VERSION: "3.6"
      CVXOPT_MSVC: "1"
    - PYTHON_VERSION: "3.5"
      CVXOPT_MSVC: "1"
    - PYTHON_VERSION: "2.7"
      COMPILER: mingwpy

# We always use a 64-bit machine, but can build x86 distributions
# with the TARGET_ARCH variable.
platform:
    - x64

matrix:
    fast_finish: true

install:
    - if [%PYTHON_ARCH%]==[64] (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
      ) else (
        call "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars32.bat"
      )

    # Set up miniconda build environment
    - SET "PATH=%PYTHON%;%PYTHON%\Scripts;%PYTHON%\Library\bin;%ProgramFiles%\7-Zip;%PATH%"
    - conda info
    - conda create --yes -n build_env python=%PYTHON_VERSION% %BUILD_DEPENDS%
    - activate build_env
    - if [%COMPILER%]==[mingwpy] ( pip install -i https://pypi.anaconda.org/carlkl/simple mingwpy )
    - SET CVXOPT_BLAS_LIB_DIR=%PYTHON%\envs\build_env\Library\lib

    # Download SuiteSparse and set CVXOPT_SUITESPARSE_SRC_DIR
    - wget -nv https://api.github.com/repos/DrTimothyAldenDavis/SuiteSparse/tarball/v%SUITESPARSE_VERSION% -O SuiteSparse-%SUITESPARSE_VERSION%.tar.gz
    - checksum -t sha256 -c %SUITESPARSE_SHA256% SuiteSparse-%SUITESPARSE_VERSION%.tar.gz
    - mkdir SuiteSparse
    - 7z x -bso0 -bsp0 SuiteSparse-%SUITESPARSE_VERSION%.tar.gz && 7z x -bso0 -bsp0 SuiteSparse-%SUITESPARSE_VERSION%.tar -oSuiteSparse
    - sh.exe -c "mv SuiteSparse/Dr*/* SuiteSparse/"
    - SET CVXOPT_SUITESPARSE_SRC_DIR=%cd%\SuiteSparse

    # Download and build GLPK
    - if [%CVXOPT_BUILD_GLPK%]==[1] (
        if [%CVXOPT_MSVC%]==[1] (
          wget -nv http://ftp.gnu.org/gnu/glpk/glpk-%GLPK_VERSION%.tar.gz &&
          checksum -t sha256 -c %GLPK_SHA256% glpk-%GLPK_VERSION%.tar.gz &&
          7z x -bso0 -bsp0 glpk-%GLPK_VERSION%.tar.gz && 7z x -bso0 -bsp0 glpk-%GLPK_VERSION%.tar &&
          cd glpk-%GLPK_VERSION%\w64 &&
          copy config_VC config.h &&
          nmake /f Makefile_VC glpk.lib &&
          cd ..\.. &&
          SET "CVXOPT_GLPK_LIB_DIR=%cd%\glpk-%GLPK_VERSION%\w64" &&
          SET "CVXOPT_GLPK_INC_DIR=%cd%\glpk-%GLPK_VERSION%\src"
        ) else (
          appveyor AddMessage "Disabled GLPK extension" -Category Warning &&
          SET "CVXOPT_BUILD_GLPK=0"
        )
      )

    # Check that we have the expected version and architecture for Python
    - python --version
    - python -c "import struct; print(struct.calcsize('P') * 8)"

    # Clone CVXOPT
    - git clone https://github.com/cvxopt/cvxopt.git

build_script:
    # Build wheel
    - cd %REPO_DIR%
    - git checkout %BUILD_COMMIT%
    - if [%COMPILER%]==[mingwpy] ( python setup.py build --compiler=mingw32 )
      else ( python setup.py build --compiler=msvc )
    - python setup.py bdist_wheel
    - ls dist/*

test_script:
    # Create test env
    - conda create --yes -n test_env python=%PYTHON_VERSION% %TEST_DEPENDS%
    - activate test_env

    # Install from wheel
    - pip install %CVXOPT_INSTALL_REQUIRES%
    - pip install --no-index --find-links dist/ %PACKAGE_NAME%

    # Run tests
    - python --version
    - python -c "from cvxopt import blas,lapack,cholmod,umfpack"
    - if [%CVXOPT_BUILD_DSDP%]==[1] ( python -c "from cvxopt import dsdp" )
    - if [%CVXOPT_BUILD_FFTW%]==[1] ( python -c "from cvxopt import fftw" )
    - if [%CVXOPT_BUILD_GLPK%]==[1] ( python -c "from cvxopt import glpk" )
    - if [%CVXOPT_BUILD_GSL%]==[1] ( python -c "from cvxopt import gsl" )
    - pytest

artifacts:
    - path: cvxopt/dist/*.whl
